import asyncio
import logging
import sys
from os import getenv

from aiogram import Bot, Dispatcher, html, F
from aiogram.client.default import DefaultBotProperties
from aiogram.enums import ParseMode
from aiogram.filters import CommandStart
from aiogram.types import Message

from keyboards.inline_kb import *
from keyboards.reply_kb import *
from db.db_utils import *
from config import settings


TOKEN = settings.token

dp = Dispatcher()


@dp.message(CommandStart())
async def command_start_handler(message: Message) -> None:
    await message.answer(
        f"Ð—Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹Ñ‚Ðµ, {html.bold(message.from_user.full_name)}! \n"
        f"Ð’Ð°Ñ Ð¿Ñ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ð±Ð¾Ñ‚ Ð¿Ð¾ Ð·Ð°ÐºÐ°Ð·Ñƒ ÐµÐ´Ñ‹."
    )
    await start_register_user(message)


async def start_register_user(message: Message) -> None:
    chat_id = message.chat.id
    full_name = message.from_user.full_name
    user = db_get_user_by_telegram(chat_id)

    if not user:
        if db_register_user(chat_id, full_name):
            await message.answer("Ð’Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹.")
        else:
            await message.answer("ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸.")
        user = db_get_user_by_telegram(chat_id)  # Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¿Ð¾ÑÐ»Ðµ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸

    if user.phone:
        await message.answer("ÐŸÑ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÐµÐ¼ Ð² Ð½Ð°ÑˆÐµÐ¼ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ðµ Ð²ÐºÑƒÑÐ½Ð¾Ð¹ ÐµÐ´Ñ‹! ðŸ¥™")
        # TODO: Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¼ÐµÐ½ÑŽ
    else:
        await message.answer(
            text="Ð”Ð»Ñ ÑÐ²ÑÐ·Ð¸ Ñ Ð’Ð°Ð¼Ð¸ Ð½Ð°Ð¼ Ð½ÑƒÐ¶ÐµÐ½ Ð’Ð°Ñˆ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð½Ñ‹Ð¹ Ð½Ð¾Ð¼ÐµÑ€ â˜Žï¸",
            reply_markup=share_phone_button(),
        )


@dp.message(F.text)
async def text_handler(message: Message) -> None:
    await message.answer(text="ÐÐµ Ð¿Ð¾Ð½Ð¸Ð¼Ð°ÑŽ. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð° Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¾Ð´Ð¸Ð½ Ð¸Ð· Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð¾Ð²")


@dp.message(F.photo)
async def text_handler(message: Message) -> None:
    await message.answer(
        text="Ð¯ Ð½Ðµ Ð²Ð¸Ð¶Ñƒ ÐºÐ°Ñ€Ñ‚Ð¸Ð½Ð¾Ðº. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð° Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¾Ð´Ð¸Ð½ Ð¸Ð· Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð¾Ð²"
    )


@dp.message(F.contact)
async def contact_handler(message: Message) -> None:
    # ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð°
    chat_id = message.chat.id
    phone = message.contact.phone_number
    db_update_user(chat_id, phone)
    if db_create_user_cart(chat_id):
        await message.answer(text="Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð¿Ñ€Ð¾ÑˆÐ»Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾")
        # TODO ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¼ÐµÐ½ÑŽ


async def main() -> None:
    bot = Bot(token=TOKEN, default=DefaultBotProperties(parse_mode=ParseMode.HTML))
    await dp.start_polling(bot)


if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO, stream=sys.stdout)
    asyncio.run(main())
